  文法クイズ機能 リニューアル要件定義書

  1. 機能概要

  1.1 背景と課題

  現状の問題点：
  - 穴埋め問題（fill_blank）でキーボード入力が必要
  - モバイルでの入力は煩雑でUXが悪い
  - スペルミスによる不本意な不正解が発生
  - 問題タイプごとにUIが異なり、学習体験が分断される

  解決策：
  デュオリンゴ式の「単語ボタンタップ」UIに統一し、すべての問題タイプで一貫した操作感を提供する。

  1.2 ゴール

  1. キーボード入力を完全排除 - タップのみで回答可能に
  2. 統一されたUI/UX - 3つの問題タイプを1つのインタラクションパターンに
  3. 適度な難易度 - 類似単語のダミーで思考を促す
  4. 快適な操作感 - アニメーションとフィードバックで楽しい学習体験

  ---
  2. ユーザーストーリー

  2.1 基本フロー

  As a 英語学習者
  I want to 単語ボタンをタップして文法問題に回答したい
  So that キーボード入力なしでサクサク学習できる

  2.2 詳細ストーリー
  ┌───────┬──────────────────────────────────────────────────────────┬────────┐
  │  ID   │                        ストーリー                        │ 優先度 │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-01 │ 問題を見て、選択肢の単語ボタンから正解をタップできる     │ Must   │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-02 │ タップした単語が回答エリアに移動するアニメーションを見る │ Must   │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-03 │ 間違えて選んだ単語をタップして取り消せる                 │ Must   │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-04 │ 並べ替え問題では複数の単語を順番に配置できる             │ Must   │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-05 │ 回答確定ボタンを押して正誤判定を受ける                   │ Must   │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-06 │ 正解/不正解のフィードバックと解説を見る                  │ Must   │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-07 │ 類似単語（活用形違いなど）が混ざった選択肢から正解を選ぶ │ Should │
  ├───────┼──────────────────────────────────────────────────────────┼────────┤
  │ US-08 │ ドラッグ&ドロップでも単語を配置できる                    │ Could  │
  └───────┴──────────────────────────────────────────────────────────┴────────┘
  ---
  3. 問題タイプ詳細仕様

  3.1 問題タイプの統一
  ┌────────────┬────────────────┬──────────────────────────────┐
  │  旧タイプ  │    新タイプ    │             説明             │
  ├────────────┼────────────────┼──────────────────────────────┤
  │ choice     │ single_select  │ 1つの単語/フレーズを選択     │
  ├────────────┼────────────────┼──────────────────────────────┤
  │ fill_blank │ word_tap       │ 空欄に入る単語をタップで選択 │
  ├────────────┼────────────────┼──────────────────────────────┤
  │ reorder    │ sentence_build │ 全単語を正しい順序に並べる   │
  └────────────┴────────────────┴──────────────────────────────┘
  3.2 Single Select（単一選択）

  従来のchoice問題の進化版

  問題: Which is correct?
        "I _____ studying English."

  選択肢ボタン:
  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
  │ am  │ │ is  │ │ are │ │ be  │
  └─────┘ └─────┘ └─────┘ └─────┘

  → タップで選択、もう一度タップで解除
  → 「回答する」ボタンで確定

  仕様：
  - 選択肢数: 4個（正解1 + ダミー3）
  - 複数選択: 不可（1つのみ）
  - ダミー生成ルール: 文法的に類似した誤答

  3.3 Word Tap（単語タップ穴埋め）

  従来のfill_blank問題の置き換え

  問題: I have _____ to Paris three times.

  回答エリア:
  ┌──────────────────────────┐
  │  ┌──────┐               │
  │  │ been │  ← タップで配置 │
  │  └──────┘               │
  └──────────────────────────┘

  単語プール:
  ┌──────┐ ┌──────┐ ┌─────┐ ┌──────┐ ┌─────┐
  │ been │ │ being│ │ was │ │ gone │ │ went│
  └──────┘ └──────┘ └─────┘ └──────┘ └─────┘

  仕様：
  - 選択肢数: 5個（正解1 + ダミー4）
  - 空欄数: 1〜2個
  - ダミー生成ルール:
    - 同じ動詞の別活用形（be → am/is/are/was/were/been/being）
    - 意味的に紛らわしい単語（go/come, make/do）
    - 文法的に間違いやすいパターン

  3.4 Sentence Build（文構築）

  従来のreorder問題の進化版

  問題: 「彼女は昨日その本を読み終えた」を英語にしましょう

  回答エリア:
  ┌────────────────────────────────────────┐
  │ ┌─────┐ ┌──────────┐ ┌───────┐ ┌─────┐│
  │ │ She │ │ finished │ │reading│ │ the ││
  │ └─────┘ └──────────┘ └───────┘ └─────┘│
  │ ┌──────┐ ┌───────────┐                │
  │ │ book │ │ yesterday │                │
  │ └──────┘ └───────────┘                │
  └────────────────────────────────────────┘

  単語プール:
  ┌─────┐ ┌──────────┐ ┌───────┐ ┌─────┐
  │ the │ │yesterday │ │reading│ │ She │  ...
  └─────┘ └──────────┘ └───────┘ └─────┘

  仕様：
  - 単語数: 5〜8個（文の長さに依存）
  - ダミー単語: 1〜2個追加（オプション、難易度調整用）
  - 語順: 正解は1つのみ（複数正解パターンは除外）

  ---
  4. UI/UX 詳細設計

  4.1 画面レイアウト

  ┌─────────────────────────────────────────┐
  │ ← 戻る    文法クイズ    問題 3/10      │ ヘッダー
  ├─────────────────────────────────────────┤
  │                                         │
  │  ┌─────────────────────────────────┐   │
  │  │ I have _____ to Paris           │   │ 問題文エリア
  │  │ three times.                    │   │
  │  │                                 │   │
  │  │ 「私はパリに3回行ったことがある」  │   │
  │  └─────────────────────────────────┘   │
  │                                         │
  ├─────────────────────────────────────────┤
  │                                         │
  │  ┌─────────────────────────────────┐   │
  │  │                                 │   │ 回答エリア
  │  │     ┌──────┐                   │   │ (選択した単語が
  │  │     │ been │                   │   │  ここに表示)
  │  │     └──────┘                   │   │
  │  │                                 │   │
  │  └─────────────────────────────────┘   │
  │                                         │
  ├─────────────────────────────────────────┤
  │                                         │
  │  ┌──────┐ ┌──────┐ ┌─────┐ ┌──────┐   │ 単語プール
  │  │ been │ │ being│ │ was │ │ gone │   │ (タップ可能な
  │  └──────┘ └──────┘ └─────┘ └──────┘   │  単語ボタン)
  │           ┌─────┐                      │
  │           │ went│                      │
  │           └─────┘                      │
  │                                         │
  ├─────────────────────────────────────────┤
  │                                         │
  │      ┌───────────────────────┐         │ アクションボタン
  │      │      回答する         │         │
  │      └───────────────────────┘         │
  │                                         │
  └─────────────────────────────────────────┘

  4.2 単語ボタンのステート
  ┌───────────┬─────────────┬─────────────┬─────────────┬──────────────────────────────┐
  │ ステート  │   背景色    │    枠線     │  テキスト   │             説明             │
  ├───────────┼─────────────┼─────────────┼─────────────┼──────────────────────────────┤
  │ Default   │ white       │ gray-200    │ gray-900    │ 未選択状態                   │
  ├───────────┼─────────────┼─────────────┼─────────────┼──────────────────────────────┤
  │ Hover     │ gray-50     │ gray-300    │ gray-900    │ ホバー時（PC）               │
  ├───────────┼─────────────┼─────────────┼─────────────┼──────────────────────────────┤
  │ Selected  │ emerald-100 │ emerald-400 │ emerald-800 │ 選択済み（回答エリアに配置） │
  ├───────────┼─────────────┼─────────────┼─────────────┼──────────────────────────────┤
  │ Disabled  │ gray-100    │ gray-200    │ gray-400    │ 選択不可（既に使用済み）     │
  ├───────────┼─────────────┼─────────────┼─────────────┼──────────────────────────────┤
  │ Correct   │ emerald-500 │ emerald-600 │ white       │ 正解時                       │
  ├───────────┼─────────────┼─────────────┼─────────────┼──────────────────────────────┤
  │ Incorrect │ red-500     │ red-600     │ white       │ 不正解時                     │
  └───────────┴─────────────┴─────────────┴─────────────┴──────────────────────────────┘
  4.3 アニメーション仕様
  ┌────────────────────────┬────────────────────────┬─────────────────────────────────┬────────────────┐
  │     アニメーション     │        トリガー        │              動作               │      時間      │
  ├────────────────────────┼────────────────────────┼─────────────────────────────────┼────────────────┤
  │ 選択アニメーション     │ 単語タップ             │ プールから回答エリアへ移動      │ 200ms ease-out │
  ├────────────────────────┼────────────────────────┼─────────────────────────────────┼────────────────┤
  │ 取り消しアニメーション │ 回答エリアの単語タップ │ 回答エリアからプールへ戻る      │ 150ms ease-in  │
  ├────────────────────────┼────────────────────────┼─────────────────────────────────┼────────────────┤
  │ 正解フィードバック     │ 正解判定時             │ 緑色にフラッシュ + スケール1.05 │ 300ms          │
  ├────────────────────────┼────────────────────────┼─────────────────────────────────┼────────────────┤
  │ 不正解フィードバック   │ 不正解判定時           │ 赤色 + 横揺れ（shake）          │ 400ms          │
  ├────────────────────────┼────────────────────────┼─────────────────────────────────┼────────────────┤
  │ 正解表示               │ 不正解後               │ 正解単語がハイライト            │ 500ms          │
  └────────────────────────┴────────────────────────┴─────────────────────────────────┴────────────────┘
  4.4 レスポンシブ対応
  ┌───────────┬─────────────────────────┬──────────────────┐
  │  画面幅   │  単語ボタンレイアウト   │  回答エリア高さ  │
  ├───────────┼─────────────────────────┼──────────────────┤
  │ < 375px   │ 2列グリッド             │ auto (min 80px)  │
  ├───────────┼─────────────────────────┼──────────────────┤
  │ 375-428px │ 3列グリッド             │ auto (min 100px) │
  ├───────────┼─────────────────────────┼──────────────────┤
  │ > 428px   │ 4列グリッド / flex-wrap │ auto (min 120px) │
  └───────────┴─────────────────────────┴──────────────────┘
  ---
  5. データモデル変更

  5.1 型定義の更新

  // shared/types/index.ts に追加

  // 新しい問題タイプ
  export type GrammarQuizType = 'single_select' | 'word_tap' | 'sentence_build';

  // 単語オプション（ダミー含む）
  export interface WordOption {
    word: string;
    isCorrect: boolean;
    isDistractor: boolean;  // 類似単語のダミーかどうか
  }

  // 更新されたクイズ問題構造
  export interface AIGrammarQuizQuestion {
    questionType: GrammarQuizType;
    question: string;           // 問題文（空欄は _____ で表記）
    questionJa?: string;        // 日本語訳/ヒント

    // Single Select / Word Tap 用
    wordOptions?: WordOption[]; // 選択肢（正解 + ダミー）
    correctAnswer: string;      // 正解（単一単語 or 完全文）

    // Sentence Build 用
    sentenceWords?: string[];   // 正解の語順
    extraWords?: string[];      // ダミー単語（難易度調整用）

    explanation: string;        // 解説
    grammarPoint?: string;      // この問題で問われる文法ポイント
  }

  // AIGrammarExtractionの更新
  export interface AIGrammarExtraction {
    patternName: string;
    patternNameEn: string;
    originalSentence: string;
    explanation: string;
    structure: string;
    example: string;
    exampleJa: string;
    level: EikenGrammarLevel;
    quizQuestions: AIGrammarQuizQuestion[];  // 更新
  }

  5.2 マイグレーション

  既存データとの互換性のため、旧形式も一時的にサポート：

  // 旧形式から新形式への変換関数
  function migrateQuizQuestion(old: OldQuizQuestion): AIGrammarQuizQuestion {
    if (old.questionType === 'choice') {
      return {
        questionType: 'single_select',
        question: old.question,
        questionJa: old.questionJa,
        wordOptions: old.options?.map((opt, i) => ({
          word: opt,
          isCorrect: opt === old.correctAnswer,
          isDistractor: false,
        })),
        correctAnswer: old.correctAnswer,
        explanation: old.explanation,
      };
    }
    // ... fill_blank, reorder の変換
  }

  ---
  6. AI プロンプト要件

  6.1 ダミー単語生成ルール

  AIに以下のルールでダミー単語を生成させる：

  ## ダミー単語生成ルール

  1. **活用形バリエーション**（最優先）
     - 動詞: 現在形/過去形/過去分詞/現在分詞/三単現
     - 例: go → went, gone, going, goes

  2. **意味的類似語**
     - 同じ文脈で使われやすい別の単語
     - 例: speak → talk, say, tell

  3. **文法的誤用パターン**
     - 学習者がよく間違えるパターン
     - 例: "I have been" vs "I have went"（been/went の混同）

  4. **品詞違い**
     - 同じ語幹で品詞が異なるもの
     - 例: success (名詞) vs successful (形容詞) vs succeed (動詞)

  ## 生成数
  - single_select: 正解1 + ダミー3 = 計4個
  - word_tap: 正解1 + ダミー4 = 計5個
  - sentence_build: 正解語彙 + ダミー1〜2個

  6.2 プロンプト例（Word Tap）

  問題タイプ: word_tap（単語タップ穴埋め）

  以下の文法パターンについて、穴埋め問題を生成してください。

  文法パターン: 現在完了形（経験）
  例文: I have visited Paris three times.

  生成する問題:
  {
    "questionType": "word_tap",
    "question": "I have _____ Paris three times.",
    "questionJa": "私はパリを3回訪れたことがある。",
    "wordOptions": [
      { "word": "visited", "isCorrect": true, "isDistractor": false },
      { "word": "visiting", "isCorrect": false, "isDistractor": true },
      { "word": "visit", "isCorrect": false, "isDistractor": true },
      { "word": "visits", "isCorrect": false, "isDistractor": true },
      { "word": "went", "isCorrect": false, "isDistractor": false }
    ],
    "correctAnswer": "visited",
    "explanation": "現在完了形「have + 過去分詞」なので、visitの過去分詞visitedが正解です。",
    "grammarPoint": "have + 過去分詞"
  }

  ダミー単語の選定理由:
  - visiting: 現在分詞との混同を誘う
  - visit: 原形との混同を誘う
  - visits: 三単現との混同を誘う
  - went: 過去形との混同を誘う（現在完了 vs 過去形）

  ---
  7. インタラクション詳細

  7.1 タップ操作フロー

  sequenceDiagram
      participant U as User
      participant P as WordPool
      participant A as AnswerArea
      participant S as System

      U->>P: 単語ボタンをタップ
      P->>A: アニメーションで移動
      P->>P: ボタンをDisabled状態に
      A->>A: 単語を表示

      Note over U,A: 取り消したい場合
      U->>A: 回答エリアの単語をタップ
      A->>P: アニメーションで戻る
      P->>P: ボタンをDefault状態に

      Note over U,S: 回答確定
      U->>S: 「回答する」ボタンをタップ
      S->>S: 正誤判定
      S->>A: 正解/不正解アニメーション
      S->>U: 解説を表示

  7.2 Sentence Build の複数単語配置

  初期状態:
  回答エリア: [ 空 ]
  単語プール: [the] [book] [She] [read] [yesterday]

  操作1: "She" をタップ
  回答エリア: [She]
  単語プール: [the] [book] [---] [read] [yesterday]

  操作2: "read" をタップ
  回答エリア: [She] [read]
  単語プール: [the] [book] [---] [---] [yesterday]

  操作3: "the" をタップ
  回答エリア: [She] [read] [the]
  ...

  最終回答: [She] [read] [the] [book] [yesterday]
  正解: "She read the book yesterday."

  7.3 エラー状態と回復
  ┌──────────────────────────────┬────────────────────────────────────┬────────────────────┐
  │             状態             │                表示                │ ユーザーアクション │
  ├──────────────────────────────┼────────────────────────────────────┼────────────────────┤
  │ 未選択で回答ボタン押下       │ 「単語を選択してください」トースト │ 単語を選択         │
  ├──────────────────────────────┼────────────────────────────────────┼────────────────────┤
  │ 並べ替え問題で単語が足りない │ 回答ボタン無効化                   │ 残り単語を配置     │
  ├──────────────────────────────┼────────────────────────────────────┼────────────────────┤
  │ 不正解                       │ 正解をハイライト表示               │ 「次へ」で進む     │
  └──────────────────────────────┴────────────────────────────────────┴────────────────────┘
  ---
  8. 実装フェーズ

  Phase 1: 基盤整備（1-2日）

  - 型定義の更新
  - WordButtonコンポーネント作成
  - AnswerAreaコンポーネント作成
  - 基本アニメーション実装

  Phase 2: Single Select 実装（1日）

  - 既存choice問題のUI刷新
  - 選択/解除ロジック
  - 正誤判定フィードバック

  Phase 3: Word Tap 実装（2日）

  - 穴埋め問題の新UI
  - AIプロンプト更新（ダミー生成）
  - 単語プール ↔ 回答エリア間の移動

  Phase 4: Sentence Build 実装（2日）

  - 複数単語の順序管理
  - 並べ替えロジック
  - 難易度調整用ダミー単語

  Phase 5: 統合・テスト（1日）

  - 3タイプの統一テスト
  - モバイル実機テスト
  - パフォーマンス最適化

  ---
  9. 成功指標（KPI）
  ┌────────────────────────────┬──────────────┬──────────┐
  │            指標            │ 現状（推定） │   目標   │
  ├────────────────────────────┼──────────────┼──────────┤
  │ 問題完了率                 │ 60%          │ 85%+     │
  ├────────────────────────────┼──────────────┼──────────┤
  │ 平均回答時間（穴埋め）     │ 15秒         │ 5秒      │
  ├────────────────────────────┼──────────────┼──────────┤
  │ ユーザー満足度             │ -            │ 4.0/5.0+ │
  ├────────────────────────────┼──────────────┼──────────┤
  │ エラー率（スペルミス起因） │ 20%          │ 0%       │
  └────────────────────────────┴──────────────┴──────────┘
  ---
  10. 将来の拡張性

  1. ドラッグ&ドロップ対応 - タップに加えてドラッグでも配置可能
  2. 音声読み上げ - 単語タップ時に発音再生
  3. ヒント機能 - 1文字目を表示するヒントボタン
  4. 難易度自動調整 - 正答率に応じてダミー数を増減
  5. タイムアタックモード - 制限時間内に何問解けるか